"use strict";var __awaiter=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))(function(i,o){function a(t){try{u(n.next(t))}catch(t){o(t)}}function s(t){try{u(n.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new r(function(e){e(t.value)}).then(a,s)}u((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function r(t){return function(e){return n([t,e])}}function n(r){if(i)throw new TypeError("Generator is already executing.");for(;u;)try{if(i=1,o&&(a=2&r[0]?o.return:r[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,r[1])).done)return a;switch(o=0,a&&(r=[2&r[0],a.value]),r[0]){case 0:case 1:a=r;break;case 4:return u.label++,{value:r[1],done:!1};case 5:u.label++,o=r[1],r=[0];continue;case 7:r=u.ops.pop(),u.trys.pop();continue;default:if(a=u.trys,!(a=a.length>0&&a[a.length-1])&&(6===r[0]||2===r[0])){u=0;continue}if(3===r[0]&&(!a||r[1]>a[0]&&r[1]<a[3])){u.label=r[1];break}if(6===r[0]&&u.label<a[1]){u.label=a[1],a=r;break}if(a&&u.label<a[2]){u.label=a[2],u.ops.push(r);break}a[2]&&u.ops.pop(),u.trys.pop();continue}r=e.call(t,u)}catch(t){r=[6,t],o=0}finally{i=a=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var i,o,a,s,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};define("ExploreActions/services/drillthrough",["require","exports"],function(t,e){function r(t){if(t){for(var e=[],r=function(t){t&&!_.isEmpty(t.args)&&1===t.values.length&&_.every(t.args,function(r,n){return e.push({column:r,value:t.values[0][n]})})},n=0,i=t;n<i.length;n++){r(i[n])}return e}}function n(t){for(var e=[],r=0,n=t;r<n.length;r++){var i=n[r];if(i.dataMap)for(var o in i.dataMap)for(var a=0,s=i.dataMap[o];a<s.length;a++){var u=s[a],c=u;if(c){var l=c.expr;if(l){var f=p.getInExpr(l);e.push(f)}}}}return e}function i(t,e,r,n){return{targetSectionName:t.sectionName,targetReportGuid:t.reportObjectId?t.reportObjectId:void 0,sectionDisplayName:t.sectionDisplayName,reportDisplayName:t.reportDisplayName?t.reportDisplayName:void 0,getFilterContext:function(){return o(t,e,r,n)},applyState:t.applyState}}function o(t,e,r,n){for(var i=[],o=[],a=0,s=t.matchedLinkFields;a<s.length;a++){var u=s[a],c=u.fieldExpr;if(!u.asAggregation&&!h.isMeasure(c)){for(var p=c.getKeyColumns(n),m=[],v=[],y=function(t){var r=_.findIndex(e,function(e){return h.equals(e.column,t)});o.push(r),m.push(e[r].column),v.push(e[r].value)},S=0,x=p;S<x.length;S++){y(x[S])}var w=f.fromSQExpr(g.inValues(m,[v]));i.push({filterExpressionMetadata:{expressions:[c]},filter:w,isTransient:!1})}}if(1===t.allowedFiltersFromSource||2===t.allowedFiltersFromSource){if(!_.isEmpty(r)){var b=l.getFiltersToApplyFromVisualQueryFilterContext(r);2!==t.allowedFiltersFromSource&&_.remove(b,function(t){return 2===t.scope});for(var F=0,E=b;F<E.length;F++){var M=E[F];i.push({filter:M.filter,isTransient:!0,filterExpressionMetadata:M.filterExpressionMetadata,restatement:M.restatement,type:M.type,displayName:M.displayName})}}for(var N=new d(n),P=function(t){if(_.includes(o,t))return"continue";var r=e[t],n=f.fromSQExpr(g.compare(0,r.column,r.value)),a=f.fromSQExpr(g.inValues([r.column],[[r.value]]));if(!_.find(i,function(t){return f.isSameFilter(t.filter,n)||f.isSameFilter(t.filter,a)})){var s=r.column.accept(N);i.push({filterExpressionMetadata:{expressions:[s]},filter:a,isTransient:!0})}},I=0;I<e.length;I++)P(I)}return i}function a(t,e,r,n,i,o){var a=new v(t,e,r,n,i),s=[];if(s.push(a),o){var u=o.getNavigators();u&&s.push.apply(s,u)}return new m(e,r,a,s)}Object.defineProperty(e,"__esModule",{value:!0});var s=powerbi.data,u=powerbi.explore.services,c=powerbi.explore.DrillthroughUtils,l=powerbi.explore.FilterUtils,p=powerbi.data.ScopeIdentityExtractor,f=s.SemanticFilter,h=s.SQExpr,g=s.SQExprBuilder,d=powerbi.explore.util.VariationToHierarchyRewriter,m=function(){function t(t,e,r,n){this.conceptualSchemaProxy=t,this.dataSources=e,this.defaultNavigator=r,this.drillthroughNavigators=n}return t.prototype.getMatchedSectionsInfo=function(t,e,r,n,i){return __awaiter(this,void 0,powerbi.Promise,function(){var o;return __generator(this,function(a){switch(a.label){case 0:return[4,this.getMatchedSections(t,void 0,e,r,n,i)];case 1:return o=a.sent(),[2,_.map(o,function(t){return _.extend(t.sectionInfo,{getFilterContext:t.action.getFilterContext})})]}})})},t.prototype.getForcedMatchSectionInfo=function(t,e,r,n,i,o){return __awaiter(this,void 0,powerbi.Promise,function(){var a,s,u;return __generator(this,function(c){switch(c.label){case 0:return[4,this.getMatchedSections(t,e,r,n,i,o)];case 1:return a=c.sent(),s=_.size(a),s<1?[2]:(u=a[0],[2,_.extend(u.sectionInfo,{getFilterContext:u.action.getFilterContext})])}})})},t.prototype.getDrillthroughActions=function(t,e,r,n){return __awaiter(this,void 0,powerbi.Promise,function(){var i;return __generator(this,function(o){switch(o.label){case 0:return[4,this.getMatchedSections(0,void 0,t,e,r,n)];case 1:return i=o.sent(),[2,_.map(i,function(t){return t.action})]}})})},t.prototype.applyDrillthroughState=function(t,e){return void 0===e&&(e=!0),__awaiter(this,void 0,powerbi.Promise,function(){return __generator(this,function(r){return[2,t.applyState(t,e)]})})},t.prototype.getDrillthroughParameters=function(t){for(var e=[],r=0,n=this.drillthroughNavigators;r<n.length;r++){var i=n[r],o=i.getDrillthroughParameters(t);_.isEmpty(o)||e.push.apply(e,o)}return e},t.prototype.getMatchedSections=function(t,e,o,a,s,u){return __awaiter(this,void 0,powerbi.Promise,function(){var c,l,p,f,h,g,d,m,v;return __generator(this,function(y){switch(y.label){case 0:return 1!==_.size(s)?[2]:(c=n(s),l=r(c),0===_.size(l)&&0!==_.size(c)?[2]:(p=_.map(l,function(t){return t.column}),[4,this.conceptualSchemaProxy.get(this.dataSources.get())]));case 1:f=y.sent(),h=[],g=0,d=this.drillthroughNavigators,y.label=2;case 2:return g<d.length?(m=d[g],[4,m.getMatchedSections(t,e,o,p,a,s,f)]):[3,5];case 3:v=y.sent(),_.isEmpty(v)||h.push.apply(h,v),y.label=4;case 4:return g++,[3,2];case 5:return[2,_.map(h,function(t){return{sectionInfo:t,action:i(t,l,u,f)}})]}})})},t}();e.create=a;var v=function(){function t(t,e,r,n,i){this.eventBridge=t,this.conceptualSchemaProxy=e,this.dataSources=r,this.explorationNavigationService=n,this.explorationStateManager=i}return t.prototype.getMatchedSections=function(t,e,r,n,i,o,a){return __awaiter(this,void 0,powerbi.Promise,function(){var s,u,l;return __generator(this,function(p){return s=c.getMeasuresFromSelectors(o,i,a),u=1===t?2:1,l=this.getMatchedSectionInfoImpl(u,e,r,n,s,a),_.isEmpty(l)?[2]:[2,l]})})},t.prototype.applyDrillthroughState=function(t,e){return __awaiter(this,void 0,powerbi.Promise,function(){var r,n,i;return __generator(this,function(o){switch(o.label){case 0:return(r=this.explorationNavigationService.getSectionByName(t.targetSectionName))?(n=c.getApplyStateInfoForInternallDrillthrough(r,t.getFilterContext(),e),n?[4,this.conceptualSchemaProxy.get(this.dataSources.get())]:[2]):[2];case 1:return i=o.sent(),this.explorationStateManager.apply(n.state,i,n.options),e&&this.eventBridge.publishToChannel(u.events.onReportChanged,{explorationContentChanged:!0}),[2]}})})},t.prototype.getDrillthroughParameters=function(t){var e=this.explorationNavigationService.getCurrentExploration(),r=e.pods,n=_.find(r,function(e){return e.boundSection===t&&1===e.type});return n?n.parameters:[]},t.prototype.getMatchedSectionInfoImpl=function(t,e,r,n,i,o){var a=this;if(!_.isEmpty(n)||!_.isEmpty(i)){var s=this.explorationNavigationService.getCurrentExploration(),u=s.pods,l=[],p=function(t){return _.isEmpty(e)||t.boundSection===e},f=function(e){return e.type===t};l=_.filter(u,function(t){return t.boundSection!==r&&p(t)&&f(t)});for(var h=[],g=this.explorationNavigationService.getAllSections(),d=function(t){var e=_.find(g,function(e){return e.name===t.boundSection}),r=m.getMatchedInfoFromPod(t,e,n,i,o);r&&h.push(r)},m=this,v=0,y=l;v<y.length;v++){var S=y[v];d(S)}if(!_.isEmpty(e)&&_.isEmpty(h)){var x=_.find(g,function(t){return t.name===e});if(!x||!this.isMatchingType(x.type,t))return;var S=_.find(u,function(t){return t.boundSection===e}),w=1;S&&(1!==S.config.acceptsFilterContext||c.hasMeasureOrAsAggregationPodParameter(S.type,S.parameters)||(w=0)),h.push({sectionDisplayName:x.displayName,sectionName:x.name,matchedLinkFields:[],allowedFiltersFromSource:w,applyState:function(t,e){return a.applyDrillthroughState(t,e)}})}return h}},t.prototype.getMatchedInfoFromPod=function(t,e,r,n,i){var o=this,a=[],s=_.filter(t.parameters,function(t){return!t.isLegacySingleSelection});if(!_.isEmpty(s)&&(a=_.map(s,function(t){return{fieldExpr:t.fieldExpr,asAggregation:t.asAggregation}}),!_.isEmpty(a))){var u=c.getMatchedLinkFields(a,r,n,i);if(!_.isEmpty(u)){var l=0===t.config.acceptsFilterContext||c.hasMeasureOrAsAggregationPodParameter(t.type,t.parameters);return{sectionDisplayName:e.displayName,sectionName:e.name,matchedLinkFields:u,allowedFiltersFromSource:l?1:0,applyState:function(t,e){return o.applyDrillthroughState(t,e)}}}}},t.prototype.isMatchingType=function(t,e){return void 0===t||0===t?1===e:1===t&&2===e},t}()}),angular.module("powerbi.explore.actions",["powerbi.explore","powerbi.common"]);