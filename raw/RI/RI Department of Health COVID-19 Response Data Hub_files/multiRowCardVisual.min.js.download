"use strict";var powerbi;!function(t){var e;!function(e){function a(t){t.append("div").classed("imgCon",!0).append("img")}function i(t,e){t.selectAll(".imgCon").style({height:o(e.maxHeight)}).selectAll("img").style({"max-height":o(e.maxHeight),"max-width":o(e.maxWidth)})}function o(t){return t+"px"}var r=t.visuals.KpiUtil.getKpiImageMetadata,n=jsCommon.CssConstants.createClassAndSelector,l=t.visuals.controls.internal.TablixUtils.EdgeSettings,s=jsCommon.PixelConverter,d=jsCommon.UrlUtils,c=e.Font.Family.semibold.css,u=e.Font.Family.regular.css,g=10,h=13,p=9,m="foregroundNeutralSecondaryAlt",f="foregroundNeutralTertiary",b="foregroundNeutralLight",w="foregroundNeutralTertiary",y=e.outline.none,v=1,C=!0,S=e.outline.leftOnly,x=3,I=n("row"),L=":tabbable",P=function(){function P(t){this.isInteractivityOverflowHidden=!1,t&&(this.interactivityEnabled=t.interactivityEnabled)}return P.prototype.init=function(t){this.options=t,this.style=t.style;var e=this.currentViewport=t.viewport,a=this.interactivity=t.interactivity;a&&"hidden"===a.overflow&&(this.isInteractivityOverflowHidden=!0);var i=this.element=$("<div/>").addClass(P.MultiRowCardRoot.class).css({height:o(e.height)});t.element.append(i),this.initializeCardRowSelection()},P.prototype.destroy=function(){this.listView&&this.listView.destroy()},P.prototype.onDataChanged=function(a){var i=this,o=a.dataViews;if(o&&o.length>0){var r=this.dataView=o[0],n=r.table.columns,l=r.table.rows,d=a.operationKind!==t.VisualDataChangeOperationKind.Append,b=this.data=P.converter(r,n.length,l.length,this.style,this.isInteractivityOverflowHidden);this.setCardDimensions(),this.listView.data(b.dataModel,function(t){return b.dataModel.indexOf(t)},d)}else{var w=function(t){return e.ColorHelper.getThemeColor(i.style,t)};this.data={dataModel:[],dataColumnCount:0,cardTitleSettings:e.LabelUtils.getDefaultLabelSettings({show:!0,labelColor:w(m),fontSize:h,fontFamily:c,style:this.style,textClassName:"dataTitle"}),categoryLabelsSettings:e.LabelUtils.getDefaultLabelSettings({show:!0,labelColor:w(f),fontSize:p,fontFamily:u,style:this.style,textClassName:"largeLightLabel"}),dataLabelsSettings:e.LabelUtils.getDefaultLabelSettings({show:!0,labelColor:w(e.ForegroundColorName),fontSize:g,fontFamily:u,style:this.style,textClassName:"largeLabel"}),cardSettings:P.getCardSettings(null,this.style)}}this.dataLabelHeight=s.toString(t.TextMeasurementService.estimateSvgTextHeight(e.FontProperties.toTextProperties(this.data.dataLabelsSettings.fontProperties))),this.categoryLabelHeight=s.toString(t.TextMeasurementService.estimateSvgTextHeight(e.FontProperties.toTextProperties(this.data.categoryLabelsSettings.fontProperties))),this.titleLabelHeight=s.toString(t.TextMeasurementService.estimateSvgTextHeight(e.FontProperties.toTextProperties(this.data.cardTitleSettings.fontProperties))),this.waitingForData=!1},P.getCardSettings=function(a,i){var o=a&&a.metadata&&a.metadata.objects?a.metadata.objects:null,r=e.ColorHelper.create(i);return{outlineSettings:{outline:t.DataViewObjects.getValue(o,e.multiRowCardProps.card.outline,y),color:r.getColorForProperty(o,e.multiRowCardProps.card.outlineColor,b),weight:t.DataViewObjects.getValue(o,e.multiRowCardProps.card.outlineWeight,v)},barSettings:{outline:t.DataViewObjects.getValue(o,e.multiRowCardProps.card.barShow,C)?S:e.outline.none,color:r.getColorForProperty(o,e.multiRowCardProps.card.barColor,w),weight:t.DataViewObjects.getValue(o,e.multiRowCardProps.card.barWeight,x)},cardPadding:t.DataViewObjects.getValue(o,e.multiRowCardProps.card.cardPadding,P.DefaultStyle.row.marginBottom),cardBackground:t.DataViewObjects.getFillColor(o,e.multiRowCardProps.card.cardBackground,P.DefaultStyle.row.background)}},P.prototype.onResizing=function(t){var e=this.currentViewport.height===t.height;if(this.currentViewport=t,this.element.css("height",o(t.height)),this.dataView){var a=this.maxColPerRow;this.maxColPerRow=this.getMaxColPerRow();var i=a===this.maxColPerRow;e&&i||this.listView.viewport(t)}},P.converter=function(a,i,o,n,l){void 0===l&&(l=!1);var s,b,w,y=[],v=a.table.rows,C=a.table.columns,S=function(t){return e.ColorHelper.getThemeColor(n,t)};if(s=e.LabelUtils.getDefaultLabelSettings({show:!0,labelColor:S(m),fontSize:h,fontFamily:c,style:n,textClassName:"dataTitle"}),w=e.LabelUtils.getDefaultLabelSettings({show:!0,labelColor:S(f),fontSize:p,fontFamily:u,style:n,textClassName:"largeLightLabel"}),b=e.LabelUtils.getDefaultLabelSettings({show:!0,labelColor:S(e.ForegroundColorName),fontSize:g,fontFamily:u,style:n,textClassName:"largeLabel"}),a.metadata&&a.metadata.objects){var x=t.DataViewObjects.getObject(a.metadata.objects,"cardTitle");e.LabelUtils.updateLabelSettingsFromLabelsObject(x,s,void 0,n);var I=t.DataViewObjects.getObject(a.metadata.objects,"dataLabels");e.LabelUtils.updateLabelSettingsFromLabelsObject(I,b,void 0,n);var L=t.DataViewObjects.getObject(a.metadata.objects,"categoryLabels");e.LabelUtils.updateLabelSettingsFromLabelsObject(L,w,void 0,n)}for(var T=0,D=o;T<D;T++){for(var V,R=v[T],F=null,H=!0,M=!1,O=!1,U=!1,j=[],A=0;A<i;A++){var N=C[A],k=r(N,R[A]),z=void 0,W=void 0;k&&(z=k.class,W=k.statusGraphic),z||(z=e.valueFormatter.formatVariantMeasureValueWithDataPointObjects(R[A],R.objects&&R.objects[A],N,P.formatStringProp,!0));var B=void 0!==k&&void 0!==k.caption,K=C[A].displayName;!H||l||N.type.numeric||(null==F?(F=A,V=z,M=e.converterHelper.isWebUrlColumn(N)&&d.isValidHttpUrl(V),O=e.converterHelper.isImageUrlColumn(N)&&d.isValidImageUrl(z),U=B):null!=F&&(H=!1,F=null)),j.push({caption:z,details:K,showURL:e.converterHelper.isWebUrlColumn(N)&&d.isValidHttpUrl(z),showImage:e.converterHelper.isImageUrlColumn(N)&&d.isValidImageUrl(z),showKPI:B,columnIndex:A})}if(null!=F){for(var E=j.slice(0,F),$=j.slice(F+1),_=0,Q=$;_<Q.length;_++){Q[_].columnIndex--}j=E.concat($)}y.push({title:null!=F?V:void 0,showTitleAsURL:M,showTitleAsImage:O,showTitleAsKPI:U,cardItemsData:j})}return{dataModel:y,dataColumnCount:y[0]?y[0].cardItemsData.length:0,cardTitleSettings:s,categoryLabelsSettings:w,dataLabelsSettings:b,cardSettings:P.getCardSettings(a,n)}},P.prototype.initializeCardRowSelection=function(){var t=this,r=this.isInteractivityOverflowHidden,n=function(e){var i=e.append("div").classed(P.Card.class,!0);t.interactivityEnabled&&(i.attr("tabindex",0),i.on("keydown.row",function(){var e=d3.event.keyCode;9===e&&!d3.event.shiftKey||39===e||40===e?t.navigateForward():(9===e&&d3.event.shiftKey||37===e||38===e)&&t.navigateBackward()})),r?i.classed("mrtile",!0):t.cardHasTitle&&i.append("div").classed(P.Title.class,!0).each(function(t){t.showTitleAsImage?a(d3.select(this)):t.showTitleAsURL?d3.select(this).append("a"):t.showTitleAsKPI&&d3.select(this).append("div").classed(P.KPITitle.class,!0).classed(t.title,!0).style({display:"inline-block",verticalAlign:"sub"})});var o=i.selectAll(P.CardItemContainer.selector).data(function(t){return t.cardItemsData}).enter().append("div").classed(P.CardItemContainer.class,!0);o.append("div").classed(P.Caption.class,!0).each(function(t){t.showURL?d3.select(this).append("a"):t.showImage?a(d3.select(this)):t.showKPI&&d3.select(this).append("div").classed(t.caption,!0).style({display:"inline-block",verticalAlign:"sub"})}),o.append("div").classed(P.Details.class,!0)},l=function(e){var a=t.getStyle(),n=t.getBorderStyles(a.row.border,a.row.padding);e.style(n).style({"margin-bottom":r?"0px":t.isSingleRowCard?"0px":o(a.row.marginBottom),background:a.row.background}),!r&&t.cardHasTitle&&(e.selectAll(P.Title.selector).filter(function(t){return!t.showTitleAsImage&&!t.showTitleAsKPI}).style({"font-size":s.fromPoint(a.title.fontSize),"font-family":a.title.family,"line-height":t.titleLabelHeight,color:a.title.color}),e.selectAll(P.Title.selector).filter(function(t){return!t.showTitleAsURL&&!t.showTitleAsImage&&!t.showTitleAsKPI}).text(function(t){return t.title}).attr("title",function(t){return t.title}),e.selectAll(P.TitleUrlSelector).text(function(t){return t.title}).attr({href:function(t){return t.title},target:"_blank",rel:"noopener noreferrer"}),e.selectAll(P.TitleImageSelector).attr("src",function(t){return t.title}),i(e.selectAll(P.Title.selector),a.imageTitle),e.selectAll(P.KPITitle.selector).each(function(t){d3.select(this).classed(t.title)}));var l=e.selectAll(P.Card.selector).attr("aria-label",function(e){return t.getFormattedCardData(e)}),d=t.getBorderStyles(a.card.border,a.card.padding);l.style(d),l.selectAll(P.Caption.selector).filter(function(t){return!t.showImage}).style({"line-height":t.dataLabelHeight,"font-size":s.fromPoint(a.caption.fontSize),"font-family":a.caption.family}).filter(function(t){return!t.showKPI}).style({color:a.caption.color}).filter(function(t){return!t.showURL}).text(function(t){return t.caption}).attr("title",function(t){return t.caption}),l.selectAll(P.CaptionImageSelector).attr("src",function(t){return t.caption}).style(a.imageCaption);var c=o(a.cardItemContainer.padding.top);if(l.selectAll(P.CardItemContainer.selector).style({"padding-top":function(e){return t.isInFirstRow(e.columnIndex)?"":c},"padding-right":function(e){return t.isLastRowItem(e.columnIndex,t.dataView.metadata.columns.length)?"0px":o(a.cardItemContainer.paddingRight)},width:function(e){return t.getColumnWidth(e.columnIndex,t.data.dataColumnCount)}}),i(l.selectAll(P.Caption.selector),a.imageCaption),l.selectAll(P.CaptionUrlSelector).attr({href:function(t){return t.caption},target:"_blank",rel:"noopener noreferrer"}).text(function(t){return t.caption}),a.details.isVisible&&l.selectAll(P.Details.selector).text(function(t){return t.details}).style({"font-size":s.fromPoint(a.details.fontSize),"font-family":a.details.family,"line-height":t.categoryLabelHeight,color:a.details.color}).attr("title",function(t){return t.details}),t.interactivityEnabled&&null!=t.targetFocusCardIndex){var u=e.filter(function(e){return t.data.dataModel.indexOf(e)===t.targetFocusCardIndex}).node();t.targetFocusCardIndex=null,u&&$(u).find(":tabbable").get(0).focus()}},d=function(t){t.remove()},c={rowHeight:void 0,enter:n,exit:d,update:l,loadMoreData:function(){return t.onLoadMoreData()},viewport:this.currentViewport,baseContainer:d3.select(this.element.get(0)),scrollEnabled:!this.isInteractivityOverflowHidden,isReadMode:function(){return 1!==t.options.host.getViewMode()}};this.listView=e.ListViewFactory.createListView(c)},P.prototype.navigateForward=function(){var t=this;this.targetFocusCardIndex=void 0,d3.event.preventDefault(),d3.event.stopPropagation();var a=$(d3.event.target).parent(I.selector).get(0);a&&a.nextElementSibling?$(a.nextElementSibling).find(L).get(0).focus():e.InteractivityUtils.tryToSelectD3Target(function(e){var a=t.data.dataModel.indexOf(e)+1,i=t.listView.getCurrentPosition(),o=i.endIndex-i.startIndex,r=t.data.dataModel.length;if(o<r&&a>=i.endIndex){t.targetFocusCardIndex=a;var n=a+1,l=n-i.endIndex;t.listView.performScrollToFrame(i.startIndex+l,n,r,o,!0)}})},P.prototype.navigateBackward=function(){var t=this;this.targetFocusCardIndex=void 0,d3.event.preventDefault(),d3.event.stopPropagation();var a=$(d3.event.target).parent(I.selector).get(0);a&&a.previousElementSibling?$(a.previousElementSibling).find(L).get(0).focus():e.InteractivityUtils.tryToSelectD3Target(function(e){var a=t.data.dataModel.indexOf(e)-1,i=t.listView.getCurrentPosition();if(a>=0&&a<i.startIndex){t.targetFocusCardIndex=a;var o=i.endIndex-i.startIndex;t.listView.performScrollToFrame(a,a+o,t.data.dataModel.length,o,!0)}})},P.prototype.getBorderStyles=function(t,e){var a={top:null!=t&&null!=t.top,right:null!=t&&null!=t.right,bottom:null!=t&&null!=t.bottom,left:null!=t&&null!=t.left},i={top:null!=e&&null!=e.top,right:null!=e&&null!=e.right,bottom:null!=e&&null!=e.bottom,left:null!=e&&null!=e.left};return{"border-top":a.top?t.top.getCSS():"","border-right":a.right?t.right.getCSS():"","border-bottom":a.bottom?t.bottom.getCSS():"","border-left":a.left?t.left.getCSS():"","padding-top":a.top&&i.top?o(e.top):"","padding-right":a.right&&i.right?o(e.right):"","padding-bottom":a.bottom&&i.bottom?o(e.bottom):"","padding-left":a.left&&i.left?o(e.left):""}},P.prototype.getFormattedCardData=function(t){var e=t.title?t.title+". ":"";return""+_.reduce(t.cardItemsData,function(t,e){return""+t+e.details+" "+e.caption+". "},e)+(this.data.dataModel.indexOf(t)+1)+" "+this.options.host.getLocalizedString("Of")+" "+this.data.dataModel.length+"."},P.prototype.getMaxColPerRow=function(){var t=this.currentViewport.width,e=this.getStyle().cardItemContainer.minWidth,a=this.data.dataColumnCount,i=Math.floor(t/e)||1;return Math.min(a,i)},P.prototype.getRowIndex=function(t){return Math.floor(1*t/this.getMaxColPerRow())},P.prototype.getStyle=function(){var t=P.DefaultStyle,e=this.getCustomStyles();if(!this.isInteractivityOverflowHidden)return $.extend(!0,{},t,e);for(var a=this.currentViewport.width,i={},o=0,r=P.tileMediaQueries;o<r.length;o++){var n=r[o];if(a<=n.maxWidth){i=n.style;break}}return $.extend(!0,{},t,e,i)},P.prototype.getSurroundSettings=function(t){var a=new l(t.weight,t.color),i=t.outline;return{top:e.outline.showTop(i)?a:null,right:e.outline.showRight(i)?a:null,bottom:e.outline.showBottom(i)?a:null,left:e.outline.showLeft(i)?a:null}},P.prototype.getCustomStyles=function(){var t=this.data.dataLabelsSettings,e=this.data.categoryLabelsSettings,a=this.data.cardTitleSettings,i=this.data.cardSettings;return{row:{border:this.getSurroundSettings(i.outlineSettings),marginBottom:i.cardPadding,background:i.cardBackground},card:{border:this.getSurroundSettings(i.barSettings)},details:{fontSize:e.fontProperties.size.pt,family:e.fontProperties.family,color:e.fontProperties.color,isVisible:e.show},caption:{fontSize:t.fontProperties.size.pt,family:t.fontProperties.family,color:t.fontProperties.color},title:{fontSize:a.fontProperties.size.pt,family:a.fontProperties.family,color:a.fontProperties.color}}},P.prototype.getColumnWidth=function(t,e){var a=this.getMaxColPerRow();if(a>=e)return 100/e+"%";var i=this.getRowIndex(t),o=Math.ceil(1*e/a),r=e%a;return i<o||0===r?100/a+"%":100/r+"%"},P.prototype.isLastRowItem=function(t,e){if(t+1===e)return!0;var a=this.getMaxColPerRow();return a-t%a===1},P.prototype.isInFirstRow=function(t){return t<this.getMaxColPerRow()},P.prototype.setCardDimensions=function(){this.cardHasTitle=!1;var t=this.data.dataModel;!this.isInteractivityOverflowHidden&&t&&t.length>0&&(this.cardHasTitle=void 0!==t[0].title,this.isSingleRowCard=1===t.length)},P.prototype.onLoadMoreData=function(){!this.waitingForData&&this.dataView.metadata&&this.dataView.metadata.segment&&(this.options.host.loadMoreData(),this.waitingForData=!0)},P.getDataLabelSettingsOptions=function(t,e,a,i){return void 0===i&&(i=!1),{enumeration:t,dataLabelsSettings:e,show:i,fontSize:!0,fontFamily:!0,style:a}},P.prototype.enumerateObjectInstances=function(t){var a=new e.ObjectEnumerationBuilder,i=this.data.cardTitleSettings,o=this.data.dataLabelsSettings,r=this.data.categoryLabelsSettings;switch(t.objectName){case"cardTitle":!this.isInteractivityOverflowHidden&&this.cardHasTitle&&e.LabelUtils.enumerateDataLabels(P.getDataLabelSettingsOptions(a,i,this.style));break;case"dataLabels":e.LabelUtils.enumerateDataLabels(P.getDataLabelSettingsOptions(a,o,this.style));break;case"categoryLabels":e.LabelUtils.enumerateDataLabels(P.getDataLabelSettingsOptions(a,r,this.style,!0));break;case e.multiRowCardProps.card.outline.objectName:this.enumerateCard(a)}return a.complete()},P.prototype.enumerateCard=function(t){var a=this.data.cardSettings,i=e.multiRowCardProps.card,o={},r=a.outlineSettings;o[i.outline.propertyName]=r.outline,r.outline!==e.outline.none&&(o[i.outlineColor.propertyName]=r.color,o[i.outlineWeight.propertyName]=r.weight);var n=a.barSettings,l=n.outline!==e.outline.none;o[i.barShow.propertyName]=l,l&&(o[i.barColor.propertyName]=n.color,o[i.barWeight.propertyName]=n.weight),o[i.cardPadding.propertyName]=a.cardPadding,o[i.cardBackground.propertyName]=a.cardBackground,t.pushInstance({selector:null,objectName:i.outline.objectName,properties:o})},P.formatStringProp={objectName:"general",propertyName:"formatString"},P.MultiRowCardRoot=n("multiRowCard"),P.Card=n("card"),P.Title=n("title"),P.CardItemContainer=n("cardItemContainer"),P.Caption=n("caption"),P.Details=n("details"),P.TitleUrlSelector=P.Title.selector+" a",P.CaptionUrlSelector=P.Caption.selector+" a",P.TitleImageSelector=P.Title.selector+" img",P.CaptionImageSelector=P.Caption.selector+" img",P.KPITitle=n("kpiTitle"),P.DefaultStyle={row:{border:null,marginBottom:20,background:void 0,padding:{top:5,right:5,bottom:5,left:5}},card:{border:null,padding:{top:10,right:10,bottom:10,left:10}},cardItemContainer:{paddingRight:20,minWidth:120,padding:{top:7}},imageCaption:{maxHeight:75,maxWidth:100},imageTitle:{maxHeight:75,maxWidth:100}},P.tileMediaQueries=[{maxWidth:250,style:{cardItemContainer:{minWidth:110},imageCaption:{maxHeight:45}}},{maxWidth:490,style:{cardItemContainer:{minWidth:130},imageCaption:{maxHeight:52}}},{maxWidth:750,style:{cardItemContainer:{minWidth:120},imageCaption:{maxHeight:53}}},{maxWidth:Number.MAX_VALUE,style:{cardItemContainer:{padding:{top:5}}}}],P}();e.MultiRowCard=P}(e=t.visuals||(t.visuals={}))}(powerbi||(powerbi={}));